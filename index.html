<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Basic Electronics - Exam System</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&family=Sarabun:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    
    <style>
        body { font-family: 'Sarabun', 'Inter', sans-serif; background-color: #f0f7ff; overflow-x: hidden; color: #1e293b; }
        .page { display: none; }
        
        .modern-blue-gradient { background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%); }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
        
        .page-active { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .cell-doing { background-color: #fbbf24; color: white; }
        .cell-done { background-color: #cbd5e1; color: white; }
        .cell-correct { background-color: #10b981; color: white; }
        .cell-wrong { background-color: #f43f5e; color: white; }
        
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner { border: 4px solid #e0f2fe; border-top: 4px solid #0ea5e9; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .bar-fill { transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        .clickable-header { cursor: pointer; transition: all 0.2s; white-space: nowrap; }
        .clickable-header:hover { background-color: #bae6fd !important; color: #0284c7; }
        
        .confetti { position: fixed; top: -50px; width: 12px; height: 12px; border-radius: 50%; opacity: 0; pointer-events: none; z-index: 100; }
        @keyframes confettiFall {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(110vh) rotate(720deg); opacity: 0; }
        }

        /* Mobile Adjustments */
        @media (max-width: 640px) {
            .container-padding { padding: 1rem; }
            h1 { font-size: 2.25rem !important; }
            .text-exam { font-size: 1.125rem !important; }
            .exam-card { padding: 1.5rem !important; border-radius: 2rem !important; }
            .opt-btn { padding: 1.25rem !important; border-radius: 1.5rem !important; font-size: 1rem !important; }
        }
    </style>
</head>
<body class="relative">

    <div id="app" class="w-full min-h-screen flex flex-col relative z-10">

        <!-- Loading Overlay -->
        <div id="loading-overlay">
            <div class="spinner mb-6"></div>
            <h2 class="text-sky-700 font-bold text-2xl mb-2 tracking-tighter">BEC System</h2>
            <div id="loading-log" class="text-xs text-gray-400 font-mono text-center px-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</div>
            <button id="btn-force-reset" onclick="forceReset()" class="hidden bg-red-500 text-white px-6 py-2 rounded-full font-bold text-xs mt-6 transition hover:bg-red-600">
                <i class="fa-solid fa-rotate-right mr-2"></i> ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏∞‡∏ö‡∏ö
            </button>
        </div>
        
        <!-- Message Modal -->
        <div id="message-modal" class="fixed inset-0 z-[10000] hidden flex items-center justify-center p-4 bg-black/20 backdrop-blur-sm">
            <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm text-center border border-slate-100">
                <div id="modal-icon" class="text-6xl mb-4 text-amber-500">‚ö†Ô∏è</div>
                <h3 id="modal-title" class="text-xl font-bold mb-2 text-slate-800">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h3>
                <p id="modal-message" class="text-slate-500 mb-6 text-sm leading-relaxed"></p>
                <button id="modal-close-btn" class="w-full bg-sky-600 text-white py-4 rounded-2xl font-bold shadow-lg transition hover:bg-sky-700 active:scale-95">‡∏ï‡∏Å‡∏•‡∏á</button>
            </div>
        </div>

        <!-- 1. Landing Page -->
        <div id="page-home" class="page w-full min-h-screen flex items-center justify-center relative overflow-hidden bg-[#f8fafc]">
            <div class="absolute top-0 right-0 w-[500px] h-[500px] modern-blue-gradient opacity-[0.03] rounded-full blur-3xl -translate-y-1/2 translate-x-1/2"></div>
            <div class="absolute bottom-0 left-0 w-[500px] h-[500px] bg-blue-400 opacity-[0.03] rounded-full blur-3xl translate-y-1/2 -translate-x-1/2"></div>

            <div class="relative z-20 text-center container-padding max-w-4xl mx-auto px-4">
                <div class="float-up mb-8">
                    <div class="inline-flex items-center gap-3 bg-white px-5 py-2.5 rounded-2xl shadow-sm border border-sky-100">
                        <i class="fa-solid fa-industry text-sky-600 text-xl"></i>
                        <span class="text-lg font-extrabold tracking-widest text-slate-700 uppercase">HANA Electronics</span>
                    </div>
                </div>
                <div class="text-center mb-12 float-up delay-1">
                    <h1 class="text-4xl md:text-7xl font-black text-slate-800 tracking-tighter leading-tight mb-4 text-center">Basic <span class="text-sky-600">Electronics</span></h1>
                    <p class="text-slate-500 text-lg md:text-xl font-medium max-w-2xl mx-auto leading-relaxed">‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ù‡πà‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï ‡∏î‡πâ‡∏≤‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô</p>
                </div>
                <div class="flex flex-col sm:flex-row gap-5 justify-center items-center float-up delay-2 mt-8">
                    <button id="btn-go-student" class="w-full sm:w-auto px-12 py-5 rounded-[2rem] modern-blue-gradient text-white font-bold text-xl shadow-2xl transition-all transform hover:-translate-y-1 hover:shadow-sky-200 active:scale-95">
                        <i class="fa-solid fa-user-graduate mr-2"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö
                    </button>
                    <button id="btn-go-teacher" class="w-full sm:w-auto px-12 py-5 rounded-[2rem] bg-white text-sky-700 font-bold text-xl shadow-lg border border-sky-100 transition-all transform hover:-translate-y-1 active:scale-95">
                        <i class="fa-solid fa-chalkboard-user mr-2"></i> ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•
                    </button>
                </div>
            </div>
        </div>

        <!-- 2. Teacher Dashboard -->
        <div id="page-teacher-dashboard" class="page w-full max-w-[98%] mx-auto pt-6 px-4 pb-12">
            <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-sky-100 flex flex-wrap justify-between items-center gap-4 mb-6">
                <div class="flex items-center gap-4">
                    <div class="bg-sky-100 p-4 rounded-2xl text-sky-600 shadow-inner"><i class="fa-solid fa-chart-pie text-2xl"></i></div>
                    <div>
                        <h2 class="text-xl md:text-2xl font-black text-slate-800">Monitor Room</h2>
                        <p class="text-slate-400 text-xs font-black uppercase tracking-widest truncate">Admin Console by Thanat Yodwong</p>
                    </div>
                </div>
                <div class="flex flex-wrap gap-3">
                     <button id="btn-toggle-system" class="px-6 py-3 rounded-2xl text-white font-bold text-sm shadow-md transition flex items-center gap-2 active:scale-95">
                        <i class="fa-solid fa-power-off"></i> <span id="txt-system-status">...</span>
                    </button>
                    <button onclick="window.location.reload()" class="px-4 py-3 rounded-2xl bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold transition">
                        <i class="fa-solid fa-arrow-rotate-right"></i>
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="bg-white p-6 rounded-[2rem] border border-sky-50 shadow-sm flex items-center gap-4 transition hover:border-sky-200">
                    <div class="w-14 h-14 rounded-2xl bg-emerald-50 text-emerald-600 flex items-center justify-center text-2xl"><i class="fa-solid fa-check-double"></i></div>
                    <div class="flex-1">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest leading-none">‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ú‡πà‡∏≤‡∏ô (%)</label>
                        <select id="config-pass-score" class="w-full text-xl font-black text-slate-700 bg-transparent outline-none cursor-pointer">
                            <option value="50">50%</option>
                            <option value="60">60%</option>
                            <option value="70">70%</option>
                            <option value="80">80%</option>
                            <option value="90">90%</option>
                            <option value="100">100%</option>
                        </select>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-[2rem] border border-sky-50 shadow-sm flex items-center gap-4 transition hover:border-sky-200">
                    <div class="w-14 h-14 rounded-2xl bg-amber-50 text-amber-600 flex items-center justify-center text-2xl"><i class="fa-solid fa-shuffle"></i></div>
                    <div class="flex-1">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest leading-none">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≠</label>
                        <select id="config-shuffle" class="w-full text-xl font-black text-slate-700 bg-transparent outline-none cursor-pointer">
                            <option value="true">‡πÄ‡∏õ‡∏¥‡∏î (ON)</option>
                            <option value="false">‡∏õ‡∏¥‡∏î (OFF)</option>
                        </select>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-[2rem] border border-sky-50 shadow-sm flex items-center gap-4">
                    <div class="w-14 h-14 rounded-2xl bg-sky-50 text-sky-600 flex items-center justify-center text-2xl"><i class="fa-solid fa-users"></i></div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest leading-none">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                        <div class="text-2xl font-black text-slate-800"><span id="student-count">0</span></div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-[2rem] border border-sky-50 shadow-sm flex items-center gap-4">
                    <div class="w-14 h-14 rounded-2xl bg-purple-50 text-purple-600 flex items-center justify-center text-2xl"><i class="fa-solid fa-graduation-cap"></i></div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest leading-none">‡∏™‡∏≠‡∏ö‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</label>
                        <div class="text-2xl font-black text-slate-800"><span id="student-pass-count">0</span></div>
                    </div>
                </div>
            </div>

            <!-- Leaderboard Area -->
            <div class="modern-blue-gradient rounded-[2.5rem] shadow-2xl p-8 text-white mb-8 relative overflow-hidden">
                <i class="fa-solid fa-trophy absolute -right-4 -bottom-4 text-9xl opacity-10 rotate-12"></i>
                <h3 class="text-2xl font-black flex items-center gap-3 mb-8"><i class="fa-solid fa-medal text-yellow-300"></i> Top 5 Leaderboard</h3>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-5" id="leaderboard-list"></div>
            </div>

            <div class="bg-white rounded-[2rem] shadow-sm border border-sky-100 p-5 mb-4 flex flex-wrap items-center justify-between gap-4">
                <div class="flex gap-6">
                    <label class="flex items-center gap-2 cursor-pointer group">
                        <input type="checkbox" id="toggle-names" class="w-5 h-5 accent-sky-600" checked>
                        <span class="text-slate-600 font-bold text-sm group-hover:text-sky-600 transition">‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer group">
                        <input type="checkbox" id="toggle-answers" class="w-5 h-5 accent-green-500">
                        <span class="text-slate-600 font-bold text-sm group-hover:text-sky-600 transition">‡πÄ‡∏â‡∏•‡∏¢‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</span>
                    </label>
                </div>
                <div class="flex gap-3">
                    <button id="btn-dl-excel" class="bg-emerald-500 text-white px-6 py-3 rounded-2xl font-bold text-sm shadow-lg transition hover:bg-emerald-600 active:scale-95"><i class="fa-solid fa-file-excel mr-2"></i> Export Excel</button>
                    <button id="btn-clear-db" class="bg-rose-50 text-rose-500 px-6 py-3 rounded-2xl font-bold text-sm transition hover:bg-rose-100 active:scale-95"><i class="fa-solid fa-trash-can mr-2"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </div>
            </div>

            <!-- Full 40 Questions Grid (Fixed Spacing) -->
            <div class="bg-white rounded-[2.5rem] shadow-sm border border-sky-100 overflow-hidden h-[650px] flex flex-col">
                <div class="flex-1 overflow-auto">
                    <table class="w-full text-left border-collapse min-w-[2400px]">
                        <thead class="bg-slate-50 sticky top-0 z-20 text-xs font-black text-slate-400 uppercase tracking-wider">
                            <tr id="grid-header-row" class="shadow-sm"></tr>
                        </thead>
                        <tbody id="grid-body" class="text-sm divide-y divide-slate-50"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- 7. Question Detail Page -->
        <div id="page-question-detail" class="page w-full max-w-7xl mx-auto pt-6 px-4 pb-12 flex-col">
            <div class="flex flex-col lg:flex-row gap-8">
                <div class="lg:w-2/3 glass-card p-8 md:p-12 rounded-[3.5rem] shadow-2xl relative overflow-hidden">
                    <div class="flex items-center justify-between mb-10 border-b border-slate-50 pb-6">
                        <button id="btn-back-dashboard" class="text-slate-400 hover:text-sky-600 font-black flex items-center gap-2 transition px-5 py-3 rounded-2xl hover:bg-sky-50 active:scale-95">
                            <i class="fa-solid fa-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö
                        </button>
                        <div class="text-center">
                            <span class="block text-[10px] text-slate-400 font-black uppercase tracking-[0.2em] mb-1">Question</span>
                            <span class="text-5xl font-black text-sky-600" id="detail-q-num">1</span>
                        </div>
                        <div class="flex gap-3">
                            <button id="btn-prev-q" class="w-14 h-14 flex items-center justify-center bg-slate-50 rounded-2xl hover:bg-sky-100 hover:text-sky-600 transition active:scale-95"><i class="fa-solid fa-chevron-left text-xl"></i></button>
                            <button id="btn-next-q" class="w-14 h-14 flex items-center justify-center bg-slate-50 rounded-2xl hover:bg-sky-100 hover:text-sky-600 transition active:scale-95"><i class="fa-solid fa-chevron-right text-xl"></i></button>
                        </div>
                    </div>
                    <div class="mb-12 text-center">
                        <h2 class="text-2xl md:text-3xl font-bold text-slate-800 mb-10 leading-relaxed px-4 text-exam" id="detail-q-text">...</h2>
                        <div id="detail-q-image" class="hidden mb-10 flex justify-center">
                            <img src="" id="detail-img-tag" alt="Q" class="max-h-80 rounded-[2rem] shadow-2xl border-[10px] border-white ring-1 ring-slate-100">
                        </div>
                    </div>
                    <div class="flex justify-center">
                        <button id="btn-toggle-detail-results" class="modern-blue-gradient text-white px-16 py-5 rounded-[2.5rem] font-bold text-2xl shadow-xl transition transform hover:scale-105 active:scale-95 flex items-center gap-4">
                            <i class="fa-solid fa-chart-simple"></i> <span id="txt-detail-btn">‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</span>
                        </button>
                    </div>
                </div>

                <div class="lg:w-1/3 space-y-6 flex flex-col">
                    <div class="bg-slate-900 text-white p-10 rounded-[3rem] shadow-xl relative overflow-hidden">
                        <div class="relative z-10 text-center">
                            <div class="text-slate-500 text-xs font-black uppercase tracking-[0.2em] mb-3">‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>
                            <div class="text-7xl font-black text-emerald-400 leading-none mb-3" id="detail-correct-count">0</div>
                            <div class="text-slate-400 text-sm font-bold uppercase tracking-widest">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div>
                            <div class="mt-8 pt-8 border-t border-slate-800 flex justify-between items-center text-xs font-black text-slate-500 uppercase tracking-widest">
                                <span>‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß</span>
                                <span class="text-white text-2xl font-black"><span id="detail-total-responses">0</span></span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-8 rounded-[3rem] shadow-sm border border-slate-100 flex-1">
                        <h3 class="font-black text-slate-700 mb-8 uppercase text-center text-[10px] tracking-[0.3em]">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</h3>
                        <div id="detail-results-container" class="space-y-5 transition-all duration-700"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Result Page -->
        <div id="page-submitted" class="page m-auto container-padding w-full max-w-lg">
            <div id="confetti-container" class="fixed inset-0 pointer-events-none z-[100]"></div>
            <div class="bg-white p-12 rounded-[4rem] shadow-2xl text-center relative overflow-hidden border border-sky-50">
                <div class="relative z-10">
                    <div id="submit-emoji" class="text-9xl mb-10 animate-bounce">üéâ</div>
                    <h2 id="submit-title" class="text-4xl font-black text-slate-800 mb-4 tracking-tighter leading-tight text-center">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß!</h2>
                    <p id="submit-message" class="text-slate-400 text-lg mb-10 leading-relaxed font-medium">‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡πÑ‡∏î‡πâ</p>
                    
                    <div class="bg-slate-50 p-10 rounded-[3.5rem] mb-12 border border-slate-100 flex flex-col items-center shadow-inner relative">
                        <div class="text-slate-400 text-[10px] font-black uppercase tracking-[0.3em] mb-2">SCORE OBTAINED</div>
                        <div class="text-8xl font-black text-sky-600 leading-none mb-4" id="submit-score">0%</div>
                        <div id="submit-badge" class="px-8 py-2.5 rounded-full font-black text-xs uppercase tracking-[0.2em] shadow-sm">...</div>
                    </div>

                    <div id="retake-box" class="hidden mb-10">
                        <p class="text-rose-500 font-bold text-sm mb-6 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-circle-exclamation"></i> ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡πÄ‡∏Å‡∏ì‡∏ë‡πå <span id="txt-pass-limit">80</span>%
                        </p>
                        <button onclick="location.reload()" class="modern-blue-gradient text-white w-full py-6 rounded-[2rem] font-bold text-2xl shadow-xl transition transform hover:scale-[1.03] active:scale-95">
                            ‡∏™‡∏≠‡∏ö‡πÅ‡∏Å‡πâ‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏°‡πà <i class="fa-solid fa-rotate-right ml-2"></i>
                        </button>
                    </div>
                    
                    <button onclick="location.reload()" class="text-slate-400 font-black text-xs uppercase tracking-[0.2em] hover:text-slate-700 transition">‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { initializeFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, writeBatch, getDocs, CACHE_SIZE_UNLIMITED } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCr08U5KYGvxXu-DZ5qZOyVnU_1MJ-oY50",
            authDomain: "rba-online-6342e.firebaseapp.com",
            databaseURL: "https://rba-online-6342e-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "rba-online-6342e",
            storageBucket: "rba-online-6342e.firebasestorage.app",
            messagingSenderId: "50383344070",
            appId: "1:50383344070:web:5003afe4c5530fc1d5a2c7",
            measurementId: "G-G75D8551FP"
        };

        const SHEET_URL = "https://docs.google.com/spreadsheets/d/163RszY_6sDDQXxWiPlkw7g5HCj_U4N49H7CMCmzWPEw/export?format=csv&gid=0";
        const TEACHER_CODE = "hana";
        
        const MASTER_QUESTIONS = [
            { t: "‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏´‡∏•‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡πÉ‡∏ô‡∏ß‡∏á‡∏à‡∏£ ‡∏Ñ‡∏∑‡∏≠", opts: ["‡∏Ç‡∏î‡∏•‡∏ß‡∏î", "‡∏ï‡∏±‡∏ß‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏£‡∏∞‡∏à‡∏∏", "‡∏ï‡∏±‡∏ß‡∏ï‡πâ‡∏≤‡∏ô‡∏ó‡∏≤‡∏ô", "‡∏´‡∏°‡πâ‡∏≠‡πÅ‡∏õ‡∏•‡∏á"], a: 2 }, 
            { t: "‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå‡∏ä‡∏ô‡∏¥‡∏î‡πÉ‡∏î ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ö‡πÅ‡∏´‡∏•‡πà‡∏á‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡πÉ‡∏ô‡∏ß‡∏á‡∏à‡∏£ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Å‡πá‡∏ö ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Ñ‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏∏‡πÑ‡∏î‡πâ", opts: ["‡∏ï‡∏±‡∏ß‡∏ï‡πâ‡∏≤‡∏ô‡∏ó‡∏≤‡∏ô", "‡∏ï‡∏±‡∏ß‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏£‡∏∞‡∏à‡∏∏", "‡∏ï‡∏±‡∏ß‡πÄ‡∏´‡∏ô‡∏µ‡πà‡∏¢‡∏ß‡∏ô‡∏≥", "‡∏´‡∏°‡πâ‡∏≠‡πÅ‡∏õ‡∏•‡∏á"], a: 1 }, 
            { t: "‡∏ï‡∏±‡∏ß‡∏ï‡πâ‡∏≤‡∏ô‡∏ó‡∏≤‡∏ô ‡∏°‡∏µ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î‡∏Ñ‡∏∑‡∏≠", opts: ["‡πÇ‡∏≠‡∏´‡πå‡∏°", "‡πÇ‡∏ß‡∏•‡∏ï‡πå", "‡πÄ‡∏Æ‡∏ô‡∏£‡∏µ‡πà", "‡πÅ‡∏≠‡∏°‡πÅ‡∏õ‡∏£‡πå"], a: 0 }, 
            { t: "‡∏Ç‡πâ‡∏≠‡πÉ‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå‡∏ó‡∏µ‡πà‡∏ú‡∏•‡∏¥‡∏ï‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏™‡∏≤‡∏£‡∏Å‡∏∂‡πà‡∏á‡∏ï‡∏±‡∏ß‡∏ô‡∏≥", opts: ["‡∏ï‡∏±‡∏ß‡πÄ‡∏´‡∏ô‡∏µ‡πà‡∏¢‡∏ß‡∏ô‡∏≥", "‡∏ï‡∏±‡∏ß‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏£‡∏∞‡∏à‡∏∏‡∏ä‡∏ô‡∏¥‡∏î‡πÑ‡∏°‡∏Å‡πâ‡∏≤", "‡∏ó‡∏£‡∏≤‡∏ô‡∏ã‡∏¥‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå", "‡∏´‡∏°‡πâ‡∏≠‡πÅ‡∏õ‡∏•‡∏á"], a: 2 }, 
            { t: "‡∏ï‡∏±‡∏ß‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏£‡∏∞‡∏à‡∏∏ ‡πÉ‡∏ä‡πâ‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏¢‡πà‡∏≠‡πÉ‡∏ô Build Sheet (B/S) ‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£", opts: ["D", "IC", "C", "Q"], a: 2 }, 
            { t: "‡∏ï‡∏±‡∏ß‡∏ï‡πâ‡∏≤‡∏ô‡∏ó‡∏≤‡∏ô ‡πÉ‡∏ä‡πâ‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏¢‡πà‡∏≠‡πÉ‡∏ô Build Sheet (B/S) ‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£", opts: ["R", "C", "L", "T"], a: 0 }, 
            { t: "‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Ç‡πâ‡∏≠‡πÉ‡∏î ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏£‡∏∞‡∏à‡∏∏‡πÅ‡∏ö‡∏ö SMD ‡∏°‡∏µ‡πÅ‡∏ñ‡∏ö‡∏™‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡πà‡∏á‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏±‡πâ‡∏ß‡∏ö‡∏ß‡∏Å ( + )", opts: ["‡πÄ‡∏ã‡∏£‡∏≤‡∏°‡∏¥‡∏Å ‡∏Ñ‡∏≤‡∏õ‡∏≤‡∏Ø", "‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Ñ‡πÇ‡∏ó‡∏£‡πÑ‡∏•‡∏ï‡∏¥‡∏Å ‡∏Ñ‡∏≤‡∏õ‡∏≤‡∏Ø", "‡∏ä‡∏¥‡∏ö‡∏Ñ‡∏≤‡∏õ‡∏≤‡∏ã‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå", "‡πÅ‡∏ó‡∏ô‡∏ó‡∏≤‡∏•‡∏±‡∏° ‡∏Ñ‡∏≤‡∏õ‡∏≤‡∏Ø"], a: 3 }, 
            { t: "‡∏ï‡∏±‡∏ß‡πÄ‡∏´‡∏ô‡∏µ‡πà‡∏¢‡∏ß‡∏ô‡∏≥‡∏°‡∏µ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î ‡∏Ñ‡∏∑‡∏≠", opts: ["‡πÇ‡∏≠‡∏´‡πå‡∏°", "‡πÄ‡∏Æ‡∏ô‡∏£‡∏µ‡πà", "‡πÇ‡∏ß‡∏•‡∏ï‡πå", "‡πÅ‡∏≠‡∏°‡πÅ‡∏õ‡∏£‡πå"], a: 1 }, 
            { t: "‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏™‡∏≤‡∏£‡∏Å‡∏∂‡πà‡∏á‡∏ï‡∏±‡∏ß‡∏ô‡∏≥‡∏ó‡∏µ‡πà‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏ß‡∏á‡∏à‡∏£‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡∏ô‡∏¥‡∏î‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ä‡∏¥‡∏ö (Chip) ‡∏™‡∏≤‡∏£‡∏Å‡∏∂‡πà‡∏á‡∏ï‡∏±‡∏ß‡∏ô‡∏≥‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πá‡∏Å‡∏°‡∏≤‡∏Å ‡∏Ñ‡∏∑‡∏≠", opts: ["‡πÑ‡∏î‡πÇ‡∏≠‡∏î", "‡∏ó‡∏£‡∏≤‡∏ô‡∏ã‡∏¥‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå", "‡πÑ‡∏ó‡∏£‡∏¥‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå", "‡∏ß‡∏á‡∏à‡∏£‡∏£‡∏ß‡∏° (IC)"], a: 3 }, 
            { t: "‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏î‡πÅ‡∏£‡∏á‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡∏™‡∏•‡∏±‡∏ö ‡∏Ñ‡∏∑‡∏≠", opts: ["‡∏´‡∏°‡πâ‡∏≠‡πÅ‡∏õ‡∏•‡∏á", "‡∏ï‡∏±‡∏ß‡πÄ‡∏´‡∏ô‡∏µ‡πà‡∏¢‡∏ß‡∏ô‡∏≥", "‡∏ï‡∏±‡∏ß‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏£‡∏∞‡∏à‡∏∏", "‡∏ï‡∏±‡∏ß‡∏ï‡πâ‡∏≤‡∏ô‡∏ó‡∏≤‡∏ô"], a: 0 }, 
            { t: "‡∏ï‡∏±‡∏ß‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏£‡∏∞‡∏à‡∏∏‡∏°‡∏µ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î ‡∏Ñ‡∏∑‡∏≠", opts: ["‡πÇ‡∏ß‡∏•‡∏ï‡πå", "‡πÇ‡∏≠‡∏´‡πå‡∏°", "‡∏ü‡∏≤‡∏£‡∏±‡∏î", "‡πÅ‡∏≠‡∏°‡πÅ‡∏õ‡∏£‡πå"], a: 2 }, 
            { t: "‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå‡∏ï‡∏±‡∏ß‡πÉ‡∏î‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÑ‡∏î‡πâ‡∏Å‡∏±‡∏ö‡∏ß‡∏≤‡∏•‡πå‡∏ß‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÑ‡∏ü‡∏ü‡πâ‡∏≤", opts: ["‡∏ï‡∏±‡∏ß‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏£‡∏∞‡∏à‡∏∏", "‡∏ï‡∏±‡∏ß‡πÄ‡∏´‡∏ô‡∏µ‡πà‡∏¢‡∏ß‡∏ô‡∏≥", "‡∏ï‡∏±‡∏ß‡∏ï‡πâ‡∏≤‡∏ô‡∏ó‡∏≤‡∏ô", "‡∏ï‡∏±‡∏ß‡∏ó‡∏£‡∏≤‡∏ô‡∏ã‡∏¥‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå"], a: 3 }, 
            { t: "‡∏ï‡∏±‡∏ß‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏£‡∏∞‡∏à‡∏∏‡∏ä‡∏ô‡∏¥‡∏î‡πÉ‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ô‡∏∂‡∏á‡∏ñ‡∏∂‡∏á‡∏Ç‡∏±‡πâ‡∏ß‡∏ö‡∏ß‡∏Å ‡∏•‡∏ö ‡πÄ‡∏™‡∏°‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏•‡∏á‡∏ö‡∏ô ‡πÅ‡∏ú‡πà‡∏ô Board", opts: ["‡∏ä‡∏ô‡∏¥‡∏î‡πÄ‡∏ã‡∏£‡∏≤‡∏°‡∏¥‡∏Å", "‡∏ä‡∏ô‡∏¥‡∏î‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©", "‡∏ä‡∏ô‡∏¥‡∏î‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡πÇ‡∏ó‡∏£‡∏•‡∏¥‡∏ï‡∏¥‡∏Å", "‡πÅ‡∏ß‡∏£‡∏¥‡πÄ‡∏≠‡πÄ‡∏ö‡∏¥‡∏•"], a: 2 }, 
            { t: "‡∏ï‡∏±‡∏ß‡πÑ‡∏î‡πÇ‡∏≠‡∏î‡∏°‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà ‡∏Ñ‡∏∑‡∏≠", opts: ["‡∏Ç‡∏¢‡∏≤‡∏¢‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì", "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•", "‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå", "‡∏ï‡∏±‡∏ß‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÇ‡∏î‡∏¢‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß"], a: 3 }, 
            { t: "‡∏Ç‡πâ‡∏≠‡πÉ‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏≤‡∏£‡∏Å‡∏∂‡πà‡∏á‡∏ï‡∏±‡∏ß‡∏ô‡∏≥", opts: ["Diode,Resistor", "LED,Inductor", "Capacitor, Resistor", "Diode, IC"], a: 2 }, 
            { t: "‡∏ï‡∏±‡∏ß‡πÄ‡∏´‡∏ô‡∏µ‡πà‡∏¢‡∏ß‡∏ô‡∏≥‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏¢‡πà‡∏≠‡πÉ‡∏ô Build sheet (B/S) ‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£", opts: ["L", "T", "D", "R"], a: 0 }, 
            { t: "‡∏ï‡∏±‡∏ß‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏¢‡∏≤‡∏¢‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏ì‡∏∞‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏Å‡πá‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ß‡∏¥‡∏ó‡∏ã‡πå‡πÑ‡∏î‡πâ ‡πÉ‡∏ä‡πâ‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏¢‡πà‡∏≠‡πÉ‡∏ô Build sheet (B/S) ‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£", opts: ["SW", "D, DR", "T, Q", "I.C, U"], a: 2 }, 
            { t: "‡∏Ç‡πâ‡∏≠‡πÉ‡∏î‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÅ‡∏ú‡∏á‡∏ß‡∏á‡∏à‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ú‡πà‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡∏•‡∏≤‡∏¢‡∏ß‡∏á‡∏à‡∏£", opts: ["PCB", "Board", "Substrate", "‡∏ñ‡∏π‡∏Å‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠"], a: 3 }, 
            { t: "‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡∏ô‡∏¥‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡∏±‡πâ‡∏ß‡πÇ‡∏•‡∏´‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏á‡∏¢‡∏∂‡∏î‡∏ï‡∏¥‡∏î‡∏ö‡∏ô‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡πâ‡∏≤ PCB ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡πÉ‡∏î", opts: ["COB", "PTH", "SMD", "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ñ‡∏π‡∏Å"], a: 2 }, 
            { t: "‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡πÉ‡∏î‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏™‡∏á‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á", opts: ["LED (‡πÅ‡∏≠‡∏• ‡∏≠‡∏µ ‡∏î‡∏µ)", "Transistor", "Resistor", "Capacitor"], a: 0 }, 
            { t: "‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏î ‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡∏•‡∏ß‡∏î‡∏ó‡∏≠‡∏á‡πÅ‡∏î‡∏á‡∏°‡∏≤‡∏û‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡πÜ ‡∏£‡∏≠‡∏ö ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏ô‡∏µ‡πà‡∏¢‡∏ß‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡∏Ç‡∏≠‡∏á‡∏™‡∏ô‡∏≤‡∏°‡πÅ‡∏°‡πà‡πÄ‡∏´‡∏•‡πá‡∏Å", opts: ["Resistor (‡∏£‡∏µ‡∏ã‡∏µ‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå)", "Capacitor (‡∏Ñ‡∏≤‡∏õ‡∏≤‡∏ã‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå)", "Inductor (‡∏≠‡∏¥‡∏ô‡∏î‡∏±‡∏Ñ‡πÄ‡∏ï‡∏≠‡∏£‡πå)", "Transistor (‡∏ó‡∏£‡∏≤‡∏ô‡∏ã‡∏¥‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå)"], a: 2 }, 
            { t: "‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡πÉ‡∏î ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÑ‡∏ü‡∏ü‡πâ‡∏≤ ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡πÅ‡∏ï‡πà‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏≤‡∏®‡∏±‡∏¢‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô‡∏õ‡πâ‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤", opts: ["Inductor (‡∏≠‡∏¥‡∏ô‡∏î‡∏±‡∏Ñ‡πÄ‡∏ï‡∏≠‡∏£‡πå)", "Capacitor (‡∏Ñ‡∏≤‡∏õ‡∏≤‡∏ã‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå)", "Buzzer (‡∏ö‡∏±‡∏ä‡πÄ‡∏ã‡∏≠‡∏£‡πå)", "Transistor (‡∏ó‡∏£‡∏≤‡∏ô‡∏ã‡∏¥‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå)"], a: 2 }, 
            { t: "‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ú‡∏¥‡∏ß‡πÅ‡∏ú‡∏á‡∏ß‡∏á‡∏à‡∏£‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏î‡∏Å‡∏£‡∏µ ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏≠‡∏∞‡πÑ‡∏£", opts: ["Component (‡∏Ñ‡∏≠‡∏°‡πÇ‡∏û‡πÄ‡∏ô‡πâ‡∏ô‡∏ó‡πå)", "Solder Resist (‡πÇ‡∏ã‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå ‡∏£‡∏µ‡∏ã‡∏µ‡∏™)", "Terminal (‡πÄ‡∏ó‡∏≠‡∏£‡πå‡∏°‡∏¥‡∏ô‡∏≠‡∏•)", "Pad, Land (‡πÅ‡∏û‡∏î, ‡πÅ‡∏•‡∏ô‡∏î‡πå)"], a: 3 }, 
            { t: "‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡∏ô‡∏¥‡∏î‡πÉ‡∏î?", img: "images/A.jpg", opts: ["Inductor (‡∏ä‡∏¥‡∏ö ‡∏≠‡∏¥‡∏ô‡∏î‡∏±‡∏Ñ‡πÄ‡∏ï‡∏≠‡∏£‡πå)", "Resistor (‡∏£‡∏µ‡∏ã‡∏µ‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå)", "Capacitor (‡∏Ñ‡∏≤‡∏õ‡∏≤‡∏ã‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå)", "Diode (‡∏ã‡∏µ‡πÄ‡∏ô‡∏≠‡∏£‡πå ‡πÑ‡∏î‡πÇ‡∏≠‡∏î)"], a: 0 }, 
            { t: "‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡∏ô‡∏¥‡∏î‡πÉ‡∏î?", img: "images/B.jpg", opts: ["Connector (‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ô‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå)", "Integrate Circuit (‡∏≠‡∏¥‡∏ô‡∏î‡∏¥‡πÄ‡∏Å‡∏£‡∏ó‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Å‡∏¥‡∏ï)", "Switch (‡∏™‡∏ß‡∏¥‡∏ó‡∏ã‡πå) ", "Transistor (‡∏ó‡∏£‡∏≤‡∏ô‡∏ã‡∏¥‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå)"], a: 1 }, 
            { t: "‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡∏ô‡∏¥‡∏î‡πÉ‡∏î?", img: "images/C.jpg", opts: ["LED (‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏≠‡∏•‡∏≠‡∏µ‡∏î‡∏µ)", "Zener Diode (‡∏ã‡∏µ‡πÄ‡∏ô‡∏≠‡∏£‡πå ‡πÑ‡∏î‡πÇ‡∏≠‡∏î)", "Crystal (‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡∏≠‡∏•)", "Buzzer (‡∏ö‡∏±‡∏ä‡πÄ‡∏ã‡∏≠‡∏£‡πå)"], a: 1 }, 
            { t: "‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡∏ô‡∏¥‡∏î‡πÉ‡∏î?", img: "images/D.jpg", opts: ["Heatsink (‡∏Æ‡∏µ‡∏ó ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå)", "Transformer (‡∏ó‡∏£‡∏≤‡∏ô‡∏ü‡∏≠‡πÄ‡∏°‡∏≠‡∏£‡πå)", "Buzzer (‡∏ö‡∏±‡∏ä‡πÄ‡∏ã‡∏≠‡∏£‡πå)", "Switch (‡∏™‡∏ß‡∏¥‡∏ó‡∏ã‡πå)"], a: 2 }, 
            { t: "‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡∏ô‡∏¥‡∏î‡πÉ‡∏î?", img: "images/E.jpg", opts: ["Electrolytic Capacitor (‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Ñ‡πÇ‡∏ó‡∏£‡πÑ‡∏•‡∏ï‡∏¥‡∏Å‡∏Ñ‡∏≤‡∏õ‡∏≤‡∏ã‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå)", "Ceramic Capacitor (‡πÄ‡∏ã‡∏£‡∏≤‡∏°‡∏¥‡∏Å‡∏Ñ‡∏≤‡∏õ‡∏≤‡∏ã‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå)", "Tantalum Capacitor (‡πÅ‡∏ó‡∏ô‡∏ó‡∏≤‡∏•‡∏±‡∏° ‡∏Ñ‡∏≤‡∏õ‡∏≤‡∏ã‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå)", "Resistor (‡∏£‡∏µ‡∏ã‡∏µ‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå)"], a: 0 }, 
            { t: "‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡∏ô‡∏¥‡∏î‡πÉ‡∏î?", img: "images/F.jpg", opts: ["Chip Resistor (‡∏ä‡∏¥‡∏ö ‡∏£‡∏µ‡∏ã‡∏µ‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå)", "Chip Capacitor (‡∏ä‡∏¥‡∏ö ‡∏Ñ‡∏≤‡∏õ‡∏≤‡∏ã‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå)", "Inductor (‡∏ä‡∏¥‡∏ö ‡∏≠‡∏¥‡∏ô‡∏î‡∏±‡∏Ñ‡πÄ‡∏ï‡∏≠‡∏£‡πå)", "Diode (‡∏ã‡∏µ‡πÄ‡∏ô‡∏≠‡∏£‡πå ‡πÑ‡∏î‡πÇ‡∏≠‡∏î)"], a: 0 }, 
            { t: "‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡∏ô‡∏¥‡∏î‡πÉ‡∏î?", img: "images/G.jpg", opts: ["Connector (‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ô‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå)", "Heat Sink (‡∏Æ‡∏µ‡∏ó ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå)", "Transformer (‡∏ó‡∏£‡∏≤‡∏ô‡∏ü‡∏≠‡πÄ‡∏°‡∏≠‡∏£‡πå)", "Crystal (‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡∏≠‡∏•)"], a: 1 }, 
            { t: "‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡∏ô‡∏¥‡∏î‡πÉ‡∏î?", img: "images/H.jpg", opts: ["Resistor (‡∏£‡∏µ‡∏ã‡∏µ‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå)", "Capacitor (‡∏Ñ‡∏≤‡∏õ‡∏≤‡∏ã‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå)", "Crystal (‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡∏≠‡∏•)", "LED (‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏≠‡∏•‡∏≠‡∏µ‡∏î‡∏µ)"], a: 2 }, 
            { t: "‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡∏ô‡∏¥‡∏î‡πÉ‡∏î?", img: "images/I.jpg", opts: ["Chip Capacitor (‡∏ä‡∏¥‡∏ö ‡∏Ñ‡∏≤‡∏õ‡∏≤‡∏ã‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå)", "Chip Resistor (‡∏ä‡∏¥‡∏ö ‡∏£‡∏µ‡∏ã‡∏µ‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå)", "Tantalum Capacitor (‡πÅ‡∏ó‡∏ô‡∏ó‡∏≤‡∏•‡∏±‡∏° ‡∏Ñ‡∏≤‡∏õ‡∏≤‡∏ã‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå)", "Inductor (‡∏ä‡∏¥‡∏ö ‡∏≠‡∏¥‡∏ô‡∏î‡∏±‡∏Ñ‡πÄ‡∏ï‡∏≠‡∏£‡πå)"], a: 0 }, 
            { t: "‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡∏ô‡∏¥‡∏î‡πÉ‡∏î?", img: "images/J.jpg", opts: ["Switch (‡∏™‡∏ß‡∏¥‡∏ó‡∏ã‡πå)", "Transformer (‡∏ó‡∏£‡∏≤‡∏ô‡∏ü‡∏≠‡πÄ‡∏°‡∏≠‡∏£‡πå)", "Buzzer (‡∏ö‡∏±‡∏ä‡πÄ‡∏ã‡∏≠‡∏£‡πå)", "Connector (‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ô‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå)"], a: 1 }, 
            { t: "‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡∏ô‡∏¥‡∏î‡πÉ‡∏î?", img: "images/K.jpg", opts: ["Electrolytic Capacitor", "Tantalum Capacitor (‡πÅ‡∏ó‡∏ô‡∏ó‡∏≤‡∏•‡∏±‡∏° ‡∏Ñ‡∏≤‡∏õ‡∏≤‡∏ã‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå)", "Ceramic Capacitor", "Resistor"], a: 1 }, 
            { t: "‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡∏ô‡∏¥‡∏î‡πÉ‡∏î?", img: "images/L.jpg", opts: ["Switch (‡∏™‡∏ß‡∏¥‡∏ó‡∏ã‡πå)", "Connector (‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ô‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå)", "Socket (‡∏ã‡πá‡∏≠‡∏Å‡πÄ‡∏Å‡πá‡∏ï)", "Terminal (‡πÄ‡∏ó‡∏≠‡∏£‡πå‡∏°‡∏¥‡∏ô‡∏≠‡∏•)"], a: 0 }, 
            { t: "‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡∏ô‡∏¥‡∏î‡πÉ‡∏î?", img: "images/M.jpg", opts: ["Diode", "Transistor (‡∏ó‡∏£‡∏≤‡∏ô‡∏ã‡∏¥‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå)", "IC", "Regulator"], a: 1 }, 
            { t: "‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡∏ô‡∏¥‡∏î‡πÉ‡∏î?", img: "images/N.jpg", opts: ["Switch (‡∏™‡∏ß‡∏¥‡∏ó‡∏ã‡πå)", "Connector (‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ô‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå)", "Header  (‡πÄ‡∏Æ‡∏î‡πÄ‡∏î‡∏≠‡∏£‡πå)", "Pin (‡∏û‡∏¥‡∏ô)"], a: 1 }, 
            { t: "‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡∏ô‡∏¥‡∏î‡πÉ‡∏î?", img: "images/O.jpg", opts: ["Resistor (‡∏£‡∏µ‡∏ã‡∏µ‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå)", "Diode (‡πÑ‡∏î‡πÇ‡∏≠‡∏î)", "Inductor (‡∏ä‡∏¥‡∏ö ‡∏≠‡∏¥‡∏ô‡∏î‡∏±‡∏Ñ‡πÄ‡∏ï‡∏≠‡∏£‡πå)", "Fuse (‡∏ü‡∏¥‡∏ß‡∏™‡πå)"], a: 0 }, 
            { t: "‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡∏ô‡∏¥‡∏î‡πÉ‡∏î?", img: "images/P.jpg", opts: ["light (‡πÑ‡∏•‡∏ó‡πå)", "Neon (‡∏ô‡∏µ‡∏≠‡∏≠‡∏ô)", "LED (‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏≠‡∏•‡∏≠‡∏µ‡∏î‡∏µ)", "Display (‡∏î‡∏µ‡∏™‡πÄ‡∏û‡∏•‡∏¢‡πå)"], a: 2 }, 
            { t: "‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡∏ô‡∏¥‡∏î‡πÉ‡∏î?", img: "images/Q.jpg", opts: ["PCB (‡∏û‡∏µ‡∏ã‡∏µ‡∏ö‡∏µ)", "Wafer (‡πÄ‡∏ß‡πÄ‡∏ü‡∏≠‡∏£‡πå)", "Panel (‡∏û‡∏≤‡πÄ‡∏ô‡∏•)", "Sheet (‡∏ã‡∏µ‡∏™)"], a: 0 }, 
        ];

        let db, auth, currentStudent = null, studentCache = null, allResults = [], showAnswers = false, showNames = true;
        let configRef, studentsRef, studentQuestions = [], studentAnswersMap = {}, currentQIndex = 0;
        let studentOptionOrders = {}, currentDetailQuestionIndex = 0, showDetailResults = false;
        let sysPassScore = 80, sysIsShuffle = true, sysIsOpen = false;

        function updateLog(msg) { const el = document.getElementById('loading-log'); if(el) el.textContent = msg; }

        async function init() {
            try {
                updateLog("‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏∞‡∏ö‡∏ö...");
                const app = initializeApp(firebaseConfig);
                db = initializeFirestore(app, { experimentalForceLongPolling: true });
                auth = getAuth(app);
                configRef = doc(db, 'bec_config_v12', 'main'); 
                studentsRef = collection(db, 'bec_students_v12');

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        updateLog("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à...");
                        loadGlobalConfig();
                        setTimeout(() => { document.getElementById('loading-overlay').style.display = 'none'; }, 800);
                    } else {
                        signInAnonymously(auth);
                    }
                });
            } catch(e) { console.error(e); }
        }

        async function loadGlobalConfig() {
            onSnapshot(configRef, (snap) => {
                if (snap.exists()) {
                    const data = snap.data();
                    sysPassScore = data.passScore || 80;
                    sysIsShuffle = data.isShuffle !== undefined ? data.isShuffle : true;
                    sysIsOpen = data.isOpen || false;
                    
                    const elPass = document.getElementById('config-pass-score');
                    const elShuf = document.getElementById('config-shuffle');
                    if(elPass) elPass.value = sysPassScore;
                    if(elShuf) elShuf.value = sysIsShuffle.toString();
                    
                    const btn = document.getElementById('btn-toggle-system');
                    if(btn) {
                        btn.innerHTML = sysIsOpen ? `<i class="fa-solid fa-lock-open"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà` : `<i class="fa-solid fa-lock"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà`;
                        btn.className = sysIsOpen ? "px-6 py-3 rounded-2xl text-white font-bold text-sm shadow-md bg-emerald-500 hover:bg-emerald-600 flex items-center gap-2" : "px-6 py-3 rounded-2xl text-white font-bold text-sm shadow-md bg-rose-500 hover:bg-rose-600 flex items-center gap-2";
                        btn.onclick = async () => await updateDoc(configRef, { isOpen: !sysIsOpen });
                    }
                } else {
                    setDoc(configRef, { isOpen: false, passScore: 80, isShuffle: true });
                }
            });
        }

        const show = (id) => {
            document.querySelectorAll('.page').forEach(el => el.style.display = 'none');
            const target = document.getElementById(id);
            if(id === 'page-student-exam' || id === 'page-home' || id === 'page-question-detail') {
                target.style.display = 'flex';
            } else {
                target.style.display = 'block';
            }
            target.classList.add('page-active');
        };

        // --- TEACHER ACTIONS ---
        document.getElementById('btn-go-teacher').onclick = () => show('page-teacher-login');
        document.getElementById('btn-go-student').onclick = () => show('page-student-login');

        document.getElementById('btn-teacher-login-final').onclick = () => {
            if(document.getElementById('teacher-room-code').value === TEACHER_CODE) {
                show('page-teacher-dashboard'); initTeacherDashboard();
            } else alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
        };

        document.getElementById('btn-back-dashboard').onclick = () => {
            show('page-teacher-dashboard');
            showDetailResults = false;
        };

        document.getElementById('config-pass-score').onchange = async (e) => {
            await updateDoc(configRef, { passScore: parseInt(e.target.value) });
        };
        document.getElementById('config-shuffle').onchange = async (e) => {
            await updateDoc(configRef, { isShuffle: e.target.value === 'true' });
        };

        function initTeacherDashboard() {
            const row = document.querySelector('thead #grid-header-row');
            // Condense table columns: Widths adjusted to bring questions closer
            row.innerHTML = `<th class="p-4 border-b w-12 text-center bg-white sticky left-0 z-20 shadow-sm">#</th><th class="p-4 border-b w-20 text-center bg-white sticky left-12 z-20 shadow-sm text-[10px]">ID</th><th class="p-4 border-b w-48 bg-white sticky left-[80px] z-20 border-r shadow-sm">Name</th><th class="p-4 border-b w-16 text-center bg-white">%</th><th class="p-4 border-b w-24 text-center bg-white">STATUS</th>`;
            MASTER_QUESTIONS.forEach((_, i) => {
                const th = document.createElement('th');
                th.className = "p-2 border-b text-center w-8 font-black text-slate-300 text-[10px] clickable-header uppercase";
                th.innerText = i + 1; th.onclick = () => openQuestionDetail(i); row.appendChild(th);
            });

            onSnapshot(query(studentsRef), (snap) => {
                allResults = []; snap.forEach(d => allResults.push(d.data()));
                renderGrid(); updateLeaderboard();
                if(document.getElementById('page-question-detail').style.display === 'flex') renderQuestionDetail();
            });
            
            document.getElementById('toggle-answers').onchange = () => renderGrid();
            document.getElementById('toggle-names').onchange = () => renderGrid();
        }

        function renderGrid() {
            const showNames = document.getElementById('toggle-names').checked;
            const showAnswers = document.getElementById('toggle-answers').checked;
            const tbody = document.getElementById('grid-body'); tbody.innerHTML = '';
            document.getElementById('student-count').innerText = allResults.length;
            const passCount = allResults.filter(s => s.score >= sysPassScore).length;
            document.getElementById('student-pass-count').innerText = passCount;
            
            allResults.sort((a,b) => (b.status === 'submitted' ? 1 : 0) - (a.status === 'submitted' ? 1 : 0));
            allResults.forEach((s, i) => {
                const isPassed = s.score !== null && s.score >= sysPassScore;
                const tr = document.createElement('tr'); tr.className = "hover:bg-slate-50 transition border-b border-slate-50 group";
                
                let statusThai = s.status === 'submitted' ? (isPassed ? "‡∏ú‡πà‡∏≤‡∏ô" : "‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô") : "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥";
                let statusColor = s.status === 'submitted' ? (isPassed ? "text-emerald-500" : "text-rose-500") : "text-amber-500";

                tr.innerHTML += `
                    <td class="p-4 text-center text-slate-400 font-bold sticky left-0 bg-white group-hover:bg-slate-50 z-10">${i+1}</td>
                    <td class="p-4 text-center text-slate-600 font-mono text-[10px] sticky left-12 bg-white group-hover:bg-slate-50 z-10">${s.studentId}</td>
                    <td class="p-4 whitespace-nowrap sticky left-[80px] bg-white group-hover:bg-slate-50 z-10 border-r"><div class="text-slate-700 font-bold text-sm">${showNames ? s.name : '***'}</div><div class="text-[10px] text-slate-400">${s.dept}</div></td>
                    <td class="p-4 text-center font-black ${isPassed ? 'text-emerald-600' : (s.score === null ? 'text-slate-300' : 'text-rose-400')}">${s.score !== null ? s.score.toFixed(0)+'%' : '-'}</td>
                    <td class="p-4 text-center"><span class="text-[10px] font-black uppercase tracking-tighter ${statusColor}">${statusThai}</span></td>
                `;
                s.answers.forEach((ansIdx, idx) => {
                    let cls = "w-5 h-5 rounded-lg mx-auto flex items-center justify-center text-[10px] font-bold ";
                    let iconText = "";
                    if (ansIdx !== null) { 
                        if(showAnswers) { 
                            const isC = (ansIdx === MASTER_QUESTIONS[idx].a); 
                            cls += isC ? "bg-emerald-500 text-white" : "bg-rose-500 text-white"; 
                            iconText = isC ? "‚úì" : "‚úï";
                        } else {
                            cls += "bg-sky-500 text-white";
                        }
                    } else cls += "bg-slate-100 text-slate-300";
                    tr.innerHTML += `<td class="p-1"><div class="${cls}">${iconText}</div></td>`;
                });
                tbody.appendChild(tr);
            });
        }

        function updateLeaderboard() {
            const ranked = allResults.filter(s => s.status === 'submitted').sort((a,b) => b.score - a.score || a.timeTaken - b.timeTaken).slice(0, 5);
            const div = document.getElementById('leaderboard-list'); div.innerHTML = '';
            if(!ranked.length) { div.innerHTML = '<div class="col-span-5 text-center py-4 opacity-50 font-bold text-sm text-white">‡∏£‡∏≠‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö...</div>'; return; }
            ranked.forEach((s, i) => {
                div.innerHTML += `
                    <div class="bg-white/10 p-5 rounded-[2rem] backdrop-blur-md flex flex-col items-center border border-white/10 transition hover:scale-105 shadow-xl">
                        <div class="text-[10px] font-black uppercase tracking-widest text-sky-200 mb-2">Rank ${i+1}</div>
                        <div class="text-sm font-bold truncate w-full text-center mb-1 text-white">${s.name}</div>
                        <div class="text-4xl font-black text-yellow-300 tracking-tighter">${s.score.toFixed(0)}%</div>
                    </div>`;
            });
        }

        function openQuestionDetail(index) {
            currentDetailQuestionIndex = index; showDetailResults = false;
            show('page-question-detail'); renderQuestionDetail();
        }

        function renderQuestionDetail() {
            const q = MASTER_QUESTIONS[currentDetailQuestionIndex];
            document.getElementById('detail-q-num').innerText = currentDetailQuestionIndex + 1;
            document.getElementById('detail-q-text').innerText = q.t;
            const imgTag = document.getElementById('detail-img-tag');
            if(q.img) {
                imgTag.parentElement.classList.remove('hidden'); 
                imgTag.src = q.img;
                imgTag.onerror = () => { imgTag.parentElement.classList.add('hidden'); };
            } else imgTag.parentElement.classList.add('hidden');
            
            let counts = [0, 0, 0, 0], totalAnswered = 0, correctCount = 0;
            allResults.forEach(s => {
                if (!s.answers) return;
                const ansIdx = s.answers[currentDetailQuestionIndex];
                if(ansIdx !== null && ansIdx !== undefined) {
                    counts[ansIdx]++; totalAnswered++; if(ansIdx === q.a) correctCount++;
                }
            });
            document.getElementById('detail-total-responses').innerText = totalAnswered;
            document.getElementById('detail-correct-count').innerText = correctCount;
            const btnToggle = document.getElementById('btn-toggle-detail-results');
            const resultsContainer = document.getElementById('detail-results-container');
            resultsContainer.innerHTML = ''; 

            if (showDetailResults) {
                btnToggle.innerHTML = `<i class="fa-solid fa-eye-slash"></i> ‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏â‡∏•‡∏¢`;
                resultsContainer.classList.remove('opacity-20', 'blur-[2px]', 'pointer-events-none');
                q.opts.forEach((optText, i) => {
                    const isCorrect = (i === q.a); const count = counts[i]; const pct = totalAnswered > 0 ? Math.round((count / totalAnswered) * 100) : 0;
                    resultsContainer.innerHTML += `
                        <div class="p-4 rounded-3xl border-2 ${isCorrect ? 'bg-emerald-50 border-emerald-400 shadow-sm' : 'bg-white border-slate-100'}">
                            <div class="flex justify-between items-center text-sm font-bold mb-2">
                                <span class="${isCorrect ? 'text-emerald-700' : 'text-slate-600'}">${String.fromCharCode(65+i)}. ${optText}</span>
                                <span class="text-slate-800">${pct}% (${count})</span>
                            </div>
                            <div class="w-full bg-slate-100 rounded-full h-2.5 overflow-hidden"><div class="bar-fill ${isCorrect ? 'bg-green-500' : 'bg-slate-300'} h-full" style="width: ${pct}%"></div></div>
                        </div>`;
                });
            } else {
                btnToggle.innerHTML = `<i class="fa-solid fa-chart-simple"></i> ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå`;
                resultsContainer.classList.add('opacity-20', 'blur-[2px]', 'pointer-events-none');
                q.opts.forEach((optText, i) => {
                    resultsContainer.innerHTML += `<div class="p-4 rounded-3xl border border-slate-50 bg-slate-50 text-xs text-slate-400 font-bold">${String.fromCharCode(65+i)}. ${optText}</div>`;
                });
            }
        }

        document.getElementById('btn-toggle-detail-results').onclick = () => { showDetailResults = !showDetailResults; renderQuestionDetail(); };
        document.getElementById('btn-prev-q').onclick = () => { if(currentDetailQuestionIndex > 0) { currentDetailQuestionIndex--; showDetailResults = false; renderQuestionDetail(); }};
        document.getElementById('btn-next-q').onclick = () => { if(currentDetailQuestionIndex < 39) { currentDetailQuestionIndex++; showDetailResults = false; renderQuestionDetail(); }};

        // --- STUDENT SYSTEM ---
        async function fetchStudents() { if(studentCache) return studentCache; const res = await fetch(SHEET_URL); const csv = await res.text(); return new Promise(r => Papa.parse(csv, {header:true, skipEmptyLines:true, complete: res=>r(res.data)})); }
        
        document.getElementById('student-id').addEventListener('input', async (e) => { 
            const id = e.target.value.trim(); 
            if(id.length < 3) return; 
            const list = await fetchStudents(); 
            const s = list.find(x => x['‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß'] == id); 
            if(s) { 
                document.getElementById('preview-name').innerText = s['‡∏ä‡∏∑‡πà‡∏≠'] + " " + s['‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•']; 
                document.getElementById('preview-dept').innerText = s['‡πÅ‡∏ú‡∏ô‡∏Å']; 
                document.getElementById('student-preview').classList.remove('hidden'); 
                studentCache = list; 
            } else document.getElementById('student-preview').classList.add('hidden'); 
        });

        document.getElementById('btn-student-login').onclick = async () => {
            if(!sysIsOpen) return alert("‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°");
            const id = document.getElementById('student-id').value.trim();
            const list = await fetchStudents(); 
            const s = list.find(x => x['‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß'] == id); 
            if(!s) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö");

            currentStudent = { id: s['‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß'], name: s['‡∏ä‡∏∑‡πà‡∏≠']+" "+s['‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'], dept: s['‡πÅ‡∏ú‡∏ô‡∏Å'], startTime: Date.now() };
            const existing = await getDoc(doc(studentsRef, currentStudent.id));
            
            if(existing.exists() && existing.data().status === 'submitted') {
                const prevScore = existing.data().score;
                if(prevScore >= sysPassScore) {
                    alert(`‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≠‡∏ö‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ${prevScore.toFixed(0)}% (‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ú‡πà‡∏≤‡∏ô ${sysPassScore}%) ‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡∏£‡∏±‡∏ö`);
                    return;
                } else {
                    if(!confirm(`‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ ${prevScore.toFixed(0)}% (‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå ${sysPassScore}%) ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÅ‡∏Å‡πâ‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
                }
            }

            await setDoc(doc(studentsRef, currentStudent.id), { studentId: currentStudent.id, name: currentStudent.name, dept: currentStudent.dept, status: 'online', score: null, answers: new Array(40).fill(null) });
            setupQuestions();
            document.getElementById('exam-student-name').innerText = currentStudent.name; 
            document.getElementById('exam-student-dept').innerText = currentStudent.dept;
            renderQuestion(); show('page-student-exam');
        };

        function setupQuestions() {
            let qs = MASTER_QUESTIONS.map((q, i) => ({ ...q, originalIndex: i }));
            if(sysIsShuffle) {
                for (let i = 39; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [qs[i], qs[j]] = [qs[j], qs[i]]; }
            }
            studentQuestions = qs;
            studentOptionOrders = {};
            studentQuestions.forEach(q => {
                let opts = [0, 1, 2, 3];
                if(sysIsShuffle) {
                    for (let i = 3; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [opts[i], opts[j]] = [opts[j], opts[i]]; }
                }
                studentOptionOrders[q.originalIndex] = opts;
            });
            currentQIndex = 0;
            studentAnswersMap = {};
        }

        function renderQuestion() {
            const q = studentQuestions[currentQIndex]; 
            document.getElementById('q-current').innerText = currentQIndex + 1; 
            document.getElementById('question-text').innerText = q.t;
            const imgContainer = document.getElementById('question-image-container'); 
            if(q.img) { imgContainer.classList.remove('hidden'); document.getElementById('question-image').src = q.img; } else imgContainer.classList.add('hidden');
            document.getElementById('progress-bar').style.width = `${((currentQIndex) / 40) * 100}%`;
            document.getElementById('btn-prev').disabled = currentQIndex === 0; 
            document.getElementById('btn-next').classList.toggle('hidden', currentQIndex === 39); 
            document.getElementById('btn-submit').classList.toggle('hidden', currentQIndex !== 39);
            
            const optsContainer = document.getElementById('options-container'); optsContainer.innerHTML = '';
            studentOptionOrders[q.originalIndex].forEach((origIdx, i) => { 
                const isSelected = studentAnswersMap[q.originalIndex] === origIdx; 
                optsContainer.innerHTML += `
                    <div onclick="selectAnswer(${origIdx})" class="opt-btn flex items-center p-6 md:p-8 border-2 rounded-[2.5rem] cursor-pointer transition-all ${isSelected ? 'border-sky-500 bg-sky-50 shadow-lg transform scale-[1.02]' : 'border-slate-100 hover:bg-slate-50 active:bg-slate-100'}">
                        <div class="w-12 h-12 rounded-full border-2 flex items-center justify-center mr-5 ${isSelected ? 'bg-sky-500 border-sky-500 text-white shadow-lg' : 'border-slate-200 bg-white'} font-black text-lg">
                            ${isSelected ? '<i class="fa-solid fa-check"></i>' : String.fromCharCode(65 + i)}
                        </div>
                        <span class="text-lg md:text-xl font-bold text-slate-700">${q.opts[origIdx]}</span>
                    </div>`; 
            });
        }

        window.selectAnswer = async (val) => { 
            const q = studentQuestions[currentQIndex]; 
            studentAnswersMap[q.originalIndex] = val; 
            renderQuestion(); 
            const masterArray = new Array(40).fill(null); 
            for(let i=0; i<40; i++) { if(studentAnswersMap[i] !== undefined) masterArray[i] = studentAnswersMap[i]; } 
            await updateDoc(doc(studentsRef, currentStudent.id), { answers: masterArray }); 
        };

        document.getElementById('btn-prev').onclick = () => { if(currentQIndex > 0) { currentQIndex--; renderQuestion(); }};
        document.getElementById('btn-next').onclick = () => { if(studentAnswersMap[studentQuestions[currentQIndex].originalIndex] === undefined) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ"); currentQIndex++; renderQuestion(); };
        
        document.getElementById('btn-submit').onclick = async () => {
            if(studentAnswersMap[studentQuestions[currentQIndex].originalIndex] === undefined) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö");
            if(!confirm("‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö?")) return;
            
            let correctCount = 0; 
            MASTER_QUESTIONS.forEach((q, i) => { if(studentAnswersMap[i] === q.a) correctCount++; });
            const finalScore = (correctCount / 40) * 100;
            const isPassed = finalScore >= sysPassScore;

            const masterArray = new Array(40).fill(null); 
            for(let i=0; i<40; i++) { if(studentAnswersMap[i] !== undefined) masterArray[i] = studentAnswersMap[i]; }
            await updateDoc(doc(studentsRef, currentStudent.id), { answers: masterArray, score: finalScore, status: 'submitted', timeTaken: (Date.now() - currentStudent.startTime)/1000 });
            
            document.getElementById('submit-score').innerText = `${finalScore.toFixed(0)}%`;
            document.getElementById('txt-pass-limit').innerText = sysPassScore;
            const badge = document.getElementById('submit-badge');
            const retakeBox = document.getElementById('retake-box');
            
            if(isPassed) {
                badge.innerText = "‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö";
                badge.className = "px-10 py-3 rounded-full font-black text-sm uppercase tracking-widest bg-emerald-100 text-emerald-600 shadow-sm";
                document.getElementById('submit-emoji').innerText = finalScore === 100 ? "ü•á" : "üéä";
                document.getElementById('submit-title').innerText = finalScore === 100 ? "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏° 100!" : "‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢ ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≠‡∏ö‡∏ú‡πà‡∏≤‡∏ô!";
                retakeBox.classList.add('hidden');
                if(finalScore >= 90) startCelebration();
            } else {
                badge.innerText = "‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥";
                badge.className = "px-10 py-3 rounded-full font-black text-sm uppercase tracking-widest bg-rose-100 text-rose-500 shadow-sm";
                document.getElementById('submit-emoji').innerText = "üí°";
                document.getElementById('submit-title').innerText = "‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á!";
                retakeBox.classList.remove('hidden');
            }
            show('page-submitted');
        };

        function startCelebration() {
            const container = document.getElementById('confetti-container');
            const emojis = ['üå∏', '‚ú®', '‚≠ê', 'üéà', 'üéâ', 'üåª', 'üíÆ'];
            for (let i = 0; i < 120; i++) {
                const el = document.createElement('div');
                el.className = 'confetti';
                el.innerText = emojis[Math.floor(Math.random() * emojis.length)];
                el.style.left = Math.random() * 100 + 'vw';
                el.style.fontSize = (Math.random() * 20 + 20) + 'px';
                el.style.animation = `confettiFall ${Math.random() * 3 + 3}s linear forwards`;
                el.style.animationDelay = Math.random() * 3 + 's';
                container.appendChild(el);
                setTimeout(() => el.remove(), 7000);
            }
        }

        document.getElementById('btn-dl-excel').onclick = () => {
            const data = allResults.map((s, i) => {
                const row = { "‡∏•‡∏≥‡∏î‡∏±‡∏ö": i+1, "‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô": s.studentId, "‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•": s.name, "‡πÅ‡∏ú‡∏ô‡∏Å": s.dept, "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô(%)": s.score || 0, "‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö": (s.score >= sysPassScore ? "‡∏ú‡πà‡∏≤‡∏ô" : "‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô") };
                s.answers.forEach((ans, idx) => { row[`‡∏Ç‡πâ‡∏≠ ${idx+1}`] = (ans === MASTER_QUESTIONS[idx].a) ? "‡∏ñ‡∏π‡∏Å" : (ans === null ? "-" : "‡∏ú‡∏¥‡∏î"); });
                return row;
            });
            const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "BEC_Results"); XLSX.writeFile(wb, "Electronics_Exam_Data.xlsx");
        };

        document.getElementById('btn-clear-db').onclick = async () => { 
            if(confirm("‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô?")) { 
                const snap = await getDocs(studentsRef); const batch = writeBatch(db); 
                snap.forEach(d => batch.delete(d.ref)); await batch.commit(); alert("‡∏•‡πâ‡∏≤‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"); 
            }
        };

        function forceReset() {
            if(confirm("‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà ‡∏ï‡∏Å‡∏•‡∏á‡πÑ‡∏´‡∏°?")) {
                localStorage.clear(); sessionStorage.clear(); window.location.reload(true);
            }
        }
        window.forceReset = forceReset;

        init();
    </script>
</body>
</html>